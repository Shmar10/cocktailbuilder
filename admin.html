<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cocktail Admin</title>
  <meta name="description" content="Admin: add and manage custom cocktail recipes." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:1rem; padding:.5rem 1rem; font-weight:600; border:1px solid #e5e7eb; background:#fff; }
    .btn-primary { background:#6d28d9; color:#fff; border-color:#6d28d9; }
    .btn-primary:hover { filter:brightness(.95); }
    .card { border:1px solid #e5e7eb; border-radius:1rem; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .input, .select, .textarea { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; background:#fff; }
    .textarea { min-height: 12rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .tag { display:inline-flex; align-items:center; border:1px solid #d1d5db; border-radius:9999px; padding:.125rem .5rem; font-size:.75rem; font-weight:600; margin-right:.25rem; margin-bottom:.25rem; background:#fff; color:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-violet-50 text-slate-800">
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-extrabold tracking-tight">üîß Cocktail Admin</h1>
      <nav class="flex items-center gap-2 text-sm">
        <a class="btn" href="index.html">‚Üê Back to site</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6 grid gap-6">
    <!-- LOCK SCREEN -->
    <section id="lockScreen" class="card p-5">
      <h2 class="text-lg font-bold">Admin sign in</h2>
      <p class="text-sm text-gray-600 mt-1">Enter the admin password you configured on the Vercel function.</p>
      <div class="grid gap-3 sm:grid-cols-[1fr_auto] mt-3">
        <input id="pwd" type="password" class="input" placeholder="Admin password" autocomplete="current-password" />
        <button id="unlockBtn" class="btn btn-primary">Unlock</button>
      </div>
      <p id="lockMsg" class="text-sm mt-2 text-red-600 hidden"></p>
    </section>

    <!-- ADMIN AREA (hidden until unlocked) -->
    <section id="adminArea" class="grid gap-6 hidden">
      <!-- Add / Paste -->
      <section class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-bold">Add recipes (paste object or array)</h2>
          <div class="text-sm text-gray-500">
            API status: <span id="apiStatus" class="mono">idle</span>
          </div>
        </div>

        <p class="text-sm text-gray-600 mt-1">
          Paste one recipe object or an array of recipe objects. JS-style is fine (single quotes, trailing commas).
          Example:
        </p>
<pre class="mono text-xs bg-slate-50 border rounded-lg p-3 overflow-auto mt-2">// Single:
{
  name: 'Old Fashioned',
  id: 'old-fashioned',
  base: ['bourbon','rye'],
  profile: ['spirit-forward','aromatic'],
  sweetness: 'dry',
  ingredients: [
    ['2 oz','Bourbon or rye'],
    ['1 tsp','Demerara syrup (2:1)'],
    ['2 dashes','Angostura bitters']
  ],
  method: 'Stir with ice 20‚Äì30 sec. Strain over a large cube.',
  glass: 'Rocks',
  garnish: 'Expressed orange peel',
  tags: ['classic','stirred']
}

// Or an array: [ { ... }, { ... } ]</pre>

        <textarea id="pasteBox" class="textarea mt-3" placeholder="Paste your object(s) here‚Ä¶"></textarea>

        <div class="flex flex-wrap gap-2 mt-3">
          <button id="validateBtn" class="btn">Validate</button>
          <button id="saveBtn" class="btn btn-primary" disabled>Save</button>
          <button id="clearBtn" class="btn">Clear</button>
          <span id="saveMsg" class="text-sm text-gray-600"></span>
        </div>

        <details class="mt-4">
          <summary class="cursor-pointer text-sm font-semibold">What formats are accepted?</summary>
          <ul class="list-disc pl-6 text-sm text-gray-700 mt-2 space-y-1">
            <li>Single object or array of objects.</li>
            <li>Keys can be <code>name, id, base, profile, sweetness, ingredients, method, glass, garnish, tags</code>.</li>
            <li><code>base</code>, <code>profile</code>, <code>tags</code> should be arrays; <code>ingredients</code> is an array of <code>[amount, item]</code> pairs.</li>
            <li>If an <code>id</code> is missing, it‚Äôs derived from <code>name</code>.</li>
          </ul>
        </details>
      </section>

      <!-- Search & Browse existing -->
      <section class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-bold">Search & browse custom-recipes.json</h2>
          <div class="text-sm text-gray-500"><span id="countLabel">0</span> recipes</div>
        </div>
        <div class="mt-3 grid gap-2 sm:grid-cols-[1fr_auto_auto]">
          <input id="searchBox" class="input" placeholder="search name, base, ingredient, tag‚Ä¶" autocomplete="off" />
          <button id="refreshBtn" class="btn">Refresh</button>
          <button id="exportBtn" class="btn">Export</button>
        </div>
        <div id="results" class="mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
      </section>
    </section>
  </main>

  <footer class="mx-auto max-w-5xl px-4 py-8 text-center text-xs text-gray-500">
    Admin panel ‚Äî no tracking. Built with vanilla JS.
  </footer>

  <script>
/** ====== CONFIG ====== **/
const API_URL = '/api/save-recipes'; // change if your Vercel route is different
const CUSTOM_FILE = 'custom-recipes.json';

/** ====== UTIL ====== **/
const $ = sel => document.querySelector(sel);
const tag = t => `<span class="tag">${t}</span>`;
const slugify = s => String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

/** Robust-ish parser that accepts JSON OR JS object/array literals.
 *  1) Try JSON.parse
 *  2) Fall back to Function(...) to evaluate as a literal (admin-only usage)
 */
function parsePasted(text){
  const t = String(text || '').trim();
  if (!t) throw new Error('Empty input');
  // Try JSON first
  try { return JSON.parse(t); } catch {}
  // Try JS literal (wrap in parentheses to allow bare objects)
  try {
    // eslint-disable-next-line no-new-func
    const val = Function('"use strict"; return (' + t + ')')();
    return val;
  } catch (e) {
    throw new Error('Could not parse input as JSON or JS literal. ' + e.message);
  }
}

function normalizeRecipe(r){
  if (!r || typeof r !== 'object') return null;
  const name = r.name || '';
  if (!name) return null;
  const out = {
    id: r.id || slugify(name),
    name,
    base: Array.isArray(r.base) ? r.base.map(x => String(x).toLowerCase()) : [],
    profile: Array.isArray(r.profile) ? r.profile : (r.profile ? [r.profile] : []),
    sweetness: r.sweetness || 'balanced',
    ingredients: Array.isArray(r.ingredients) ? r.ingredients.map(p => Array.isArray(p) ? p : [p.amount||'', p.item||'']) : [],
    method: r.method || '',
    glass: r.glass || '',
    garnish: r.garnish || '',
    tags: Array.isArray(r.tags) ? r.tags : (r.tags ? [r.tags] : [])
  };
  return out;
}

function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

/** ====== LOCK / UNLOCK ====== **/
const lockScreen = $('#lockScreen');
const adminArea = $('#adminArea');
const pwdInput = $('#pwd');
const unlockBtn = $('#unlockBtn');
const lockMsg = $('#lockMsg');

function hasSession(){
  return sessionStorage.getItem('ADMIN_UNLOCK') === '1' &&
         !!sessionStorage.getItem('ADMIN_PASSWORD');
}
function setSession(pwd){
  sessionStorage.setItem('ADMIN_UNLOCK','1');
  sessionStorage.setItem('ADMIN_PASSWORD', pwd);
}
function clearSession(){
  sessionStorage.removeItem('ADMIN_UNLOCK');
  sessionStorage.removeItem('ADMIN_PASSWORD');
}

unlockBtn.addEventListener('click', () => {
  const pwd = pwdInput.value.trim();
  if (!pwd){ lockMsg.textContent = 'Please enter a password.'; lockMsg.classList.remove('hidden'); return; }
  lockMsg.classList.add('hidden');
  setSession(pwd);
  hide(lockScreen);
  show(adminArea);
  loadCustom();
});
if (hasSession()){
  hide(lockScreen); show(adminArea);
  loadCustom();
}

/** ====== ADD / SAVE ====== **/
const pasteBox = $('#pasteBox');
const validateBtn = $('#validateBtn');
const saveBtn = $('#saveBtn');
const clearBtn = $('#clearBtn');
const saveMsg = $('#saveMsg');
const apiStatus = $('#apiStatus');

let validated = []; // holds normalized recipes ready to save

validateBtn.addEventListener('click', () => {
  try {
    const raw = parsePasted(pasteBox.value);
    const list = Array.isArray(raw) ? raw : [raw];
    const normalized = list.map(normalizeRecipe).filter(Boolean);

    if (!normalized.length) throw new Error('No valid recipes found.');
    validated = normalized;

    saveMsg.textContent = `Validated ${validated.length} recipe${validated.length===1?'':'s'}.`;
    saveMsg.classList.remove('text-red-600');
    saveBtn.disabled = false;
  } catch (e) {
    validated = [];
    saveBtn.disabled = true;
    saveMsg.textContent = e.message || 'Validation failed.';
    saveMsg.classList.add('text-red-600');
  }
});

clearBtn.addEventListener('click', () => {
  pasteBox.value = '';
  validated = [];
  saveBtn.disabled = true;
  saveMsg.textContent = '';
});

async function postOne(recipe, password){
  const body = { password, recipe };
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok){
    const txt = await res.text().catch(()=> '');
    throw new Error(`API error (${res.status}): ${txt || 'request failed'}`);
  }
  return res.json();
}

saveBtn.addEventListener('click', async () => {
  if (!validated.length) return;
  const password = sessionStorage.getItem('ADMIN_PASSWORD') || '';
  if (!password){ clearSession(); location.reload(); return; }

  apiStatus.textContent = 'saving‚Ä¶';
  saveBtn.disabled = true;

  let ok = 0, fail = 0, errors = [];
  for (const r of validated){
    try {
      // one-by-one upsert (server upserts by id)
      await postOne(r, password);
      ok++;
    } catch (e) {
      fail++;
      errors.push(`${r.name}: ${e.message}`);
    }
  }

  apiStatus.textContent = 'idle';
  if (fail === 0){
    saveMsg.textContent = `Saved ${ok} recipe${ok===1?'':'s'} ‚úî`;
    saveMsg.classList.remove('text-red-600');
    // Refresh list view
    await loadCustom();
  } else {
    saveMsg.textContent = `Saved ${ok}, failed ${fail}. See console for details.`;
    saveMsg.classList.add('text-red-600');
    console.error('Save errors:', errors);
  }
});

/** ====== SEARCH & BROWSE ====== **/
const searchBox = $('#searchBox');
const refreshBtn = $('#refreshBtn');
const exportBtn = $('#exportBtn');
const results = $('#results');
const countLabel = $('#countLabel');

let CUSTOM_CACHE = [];

async function fetchCustom(){
  try {
    const r = await fetch(CUSTOM_FILE, { cache: 'no-store' });
    if (!r.ok) return [];
    const j = await r.json();
    return Array.isArray(j) ? j : [];
  } catch {
    return [];
  }
}

async function loadCustom(){
  CUSTOM_CACHE = await fetchCustom();
  countLabel.textContent = CUSTOM_CACHE.length;
  renderList(CUSTOM_CACHE);
}

function searchHits(r, q) {
  const s = q.toLowerCase().trim();
  if (!s) return true;
  const hit = (txt) => String(txt||'').toLowerCase().includes(s);
  if (hit(r.name)) return true;
  if ((r.base||[]).some(hit)) return true;
  if ((r.tags||[]).some(hit)) return true;
  if (hit(r.method)) return true;
  if ((r.ingredients||[]).some(([a,i]) => hit(a) || hit(i))) return true;
  return false;
}

function renderList(list){
  results.innerHTML = '';
  if (!list.length){
    results.innerHTML = '<p class="text-sm text-gray-500">No recipes found.</p>';
    return;
  }
  list.slice(0, 120).forEach(r => {
    const ing = (r.ingredients||[]).map(([a,i]) => `<li><b>${a}</b> ${i}</li>`).join('');
    const card = document.createElement('div');
    card.className = 'card p-3';
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <h4 class="font-semibold">${r.name}</h4>
          <div class="text-xs text-gray-600 mt-1">
            ${(r.base||[]).join(', ')}
            ${(r.tags||[]).length ? ' ‚Ä¢ ' + (r.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ') : ''}
          </div>
        </div>
        <button class="btn" data-copy="${r.id}">Copy JSON</button>
      </div>
      <details class="mt-2">
        <summary class="cursor-pointer text-sm">Preview ingredients</summary>
        <ul class="list-disc pl-6 text-sm mt-1">${ing}</ul>
      </details>
    `;
    results.appendChild(card);
  });

  // Copy handlers
  results.querySelectorAll('[data-copy]').forEach(btn => btn.addEventListener('click', e => {
    const id = e.currentTarget.getAttribute('data-copy');
    const rec = CUSTOM_CACHE.find(x => (x.id || slugify(x.name)) === id);
    if (!rec) return;
    const txt = JSON.stringify(rec, null, 2);
    const ta = document.createElement('textarea');
    ta.value = txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    e.currentTarget.textContent = 'Copied!';
    setTimeout(() => e.currentTarget.textContent = 'Copy JSON', 1000);
  }));
}

searchBox.addEventListener('input', () => {
  const q = searchBox.value;
  const filtered = CUSTOM_CACHE.filter(r => searchHits(r, q));
  countLabel.textContent = filtered.length;
  renderList(filtered);
});

refreshBtn.addEventListener('click', async () => {
  refreshBtn.disabled = true;
  await loadCustom();
  refreshBtn.disabled = false;
});

exportBtn.addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(CUSTOM_CACHE, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'custom-recipes.json';
  document.body.appendChild(a); a.click(); a.remove();
});
  </script>
</body>
</html>
