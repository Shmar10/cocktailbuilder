<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Cocktail Catalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:1rem; padding:.5rem 1rem; font-weight:600; border:1px solid #e5e7eb; background:#fff; }
    .btn-primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .input, textarea { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; background:#fff; }
    .card { border:1px solid #e5e7eb; border-radius:1rem; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .muted { color:#64748b; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-cyan-50 text-slate-800">
  <div class="mx-auto max-w-3xl p-4">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-extrabold">Admin — Cocktail Catalog</h1>
      <a href="./" class="btn">← Back</a>
    </header>

    <!-- GATE: password only -->
    <section id="gate" class="card p-4 mt-4">
      <h2 class="font-bold">Enter Admin Password</h2>
      <p class="text-sm muted">The API URL will be requested once after you unlock (and remembered on this browser).</p>
      <div class="mt-2 grid gap-2 sm:grid-cols-[1fr_auto]">
        <input id="pw" type="password" placeholder="Admin password" class="input" autocomplete="current-password" />
        <button id="unlockBtn" class="btn btn-primary">Unlock</button>
      </div>
      <p id="gateStatus" class="text-sm mt-2"></p>
    </section>

    <!-- MAIN: hidden until password validated -->
    <section id="main" class="hidden">
      <div class="card p-4 mt-4">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="font-bold">Paste recipe object(s)</h2>
            <p class="text-sm muted">Paste a single object or an array — exactly like your <code>catalog.js</code> format.</p>
          </div>
          <div class="text-right">
            <button id="changeApiBtn" class="btn">Change API URL</button>
            <div class="text-xs muted mt-1" id="apiUrlDisplay"></div>
          </div>
        </div>
        <textarea id="rawObj" rows="12" class="mt-3 input" placeholder="{ name: 'Old Fashioned', id: 'old-fashioned', base: ['bourbon','rye'], ... }"></textarea>
        <div class="mt-3 flex items-center gap-2">
          <button id="submitRawBtn" class="btn btn-primary">Save Pasted Object(s)</button>
          <span id="statusRaw" class="text-sm muted"></span>
        </div>
        <details class="mt-3">
          <summary class="cursor-pointer text-sm font-semibold">Example (click to insert)</summary>
          <pre id="exampleText" class="mt-2 text-sm bg-slate-50 p-3 rounded-lg overflow-auto">{ name: 'Kingston Sour', base: ['jamaican rum'], profile: ['citrusy'], sweetness: 'balanced', ingredients: [['2 oz','Jamaican rum'],['0.75 oz','Lime juice'],['0.5 oz','Simple syrup'],['1 dash','Angostura']], method: 'Shake with ice; fine strain into coupe.', glass: 'Coupe', garnish: 'Lime wheel', tags: ['modern','shaken'] }</pre>
          <div class="mt-2"><button id="insertExample" class="btn">Insert example</button></div>
        </details>
      </div>
    </section>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const gate = document.getElementById('gate');
  const main = document.getElementById('main');
  const unlockBtn = document.getElementById('unlockBtn');
  const pwInput = document.getElementById('pw');
  const gateStatus = document.getElementById('gateStatus');
  const apiUrlDisplay = document.getElementById('apiUrlDisplay');
  const changeApiBtn = document.getElementById('changeApiBtn');
  const rawTextarea = document.getElementById('rawObj');
  const submitRawBtn = document.getElementById('submitRawBtn');
  const insertExampleBtn = document.getElementById('insertExample');
  const exampleText = document.getElementById('exampleText');

  // Helpers
  const getApiUrl = () => localStorage.getItem('catalogApiUrl') || '';
  const setApiUrl = (v) => { localStorage.setItem('catalogApiUrl', v); renderApiUrl(); };
  const renderApiUrl = () => { apiUrlDisplay.textContent = getApiUrl() ? `API: ${getApiUrl()}` : 'API not set yet'; };

  // Prompt for API if missing
  function ensureApiUrl() {
    let url = getApiUrl();
    if (!url) {
      url = prompt('Enter your Vercel API URL (e.g., https://<project>.vercel.app/api/save-recipe)') || '';
      url = url.trim();
      if (!url) return null;
      setApiUrl(url);
    }
    return url;
  }

  renderApiUrl();

  changeApiBtn.addEventListener('click', () => {
    const current = getApiUrl();
    const next = prompt('Update API URL', current || 'https://<project>.vercel.app/api/save-recipe');
    if (next !== null) setApiUrl((next || '').trim());
  });

  // Unlock flow:
  // 1) Ask for API URL if needed
  // 2) POST {password, recipes:[]} (empty list) to validate password without writing
  //    - 400 "no-recipes" => password OK -> unlock
  //    - 401 "unauthorized" => wrong password
  //    - other => show error
  unlockBtn.addEventListener('click', async () => {
    gateStatus.textContent = '';
    const password = pwInput.value.trim();
    if (!password) { gateStatus.textContent = 'Please enter a password.'; return; }

    const apiUrl = ensureApiUrl();
    if (!apiUrl) { gateStatus.textContent = 'API URL is required.'; return; }

    gateStatus.textContent = 'Checking password…';
    try {
      const r = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password, recipes: [] })
      });
      const j = await r.json().catch(() => ({}));

      if (r.status === 401) {
        gateStatus.textContent = 'Incorrect password.';
        return;
      }
      if (r.status === 400 && (j.error === 'no-recipes' || j.error === 'no-recipes-provided')) {
        // success: password accepted
        localStorage.setItem('catalogAdminPw', password);
        gate.classList.add('hidden');
        main.classList.remove('hidden');
        return;
      }
      if (!r.ok) {
        gateStatus.textContent = `API error: ${j.error || r.status}`;
        return;
      }
      // Some APIs might return ok:true even with empty array; treat as success.
      localStorage.setItem('catalogAdminPw', password);
      gate.classList.add('hidden');
      main.classList.remove('hidden');
    } catch (e) {
      console.error(e);
      gateStatus.textContent = 'Network error — check your API URL.';
    }
  });

  // Insert example text
  insertExampleBtn.addEventListener('click', () => {
    rawTextarea.value = exampleText.textContent.trim();
  });

  // Save raw object(s)
  submitRawBtn.addEventListener('click', async () => {
    const apiUrl = getApiUrl();
    const password = localStorage.getItem('catalogAdminPw') || pwInput.value.trim();
    if (!apiUrl) { alert('API URL missing — click “Change API URL” to set it.'); return; }
    if (!password) { alert('Password missing — reload and unlock again.'); return; }

    const raw = rawTextarea.value.trim();
    if (!raw) { alert('Paste a recipe object or an array of objects.'); return; }

    let parsed;
    try {
      // Allow JS-ish objects: single quotes, trailing commas, unquoted keys.
      parsed = (new Function('return (' + raw + ')'))();
    } catch (e) {
      console.error('Parse error', e);
      document.getElementById('statusRaw').textContent = 'Parse error — check your object syntax.';
      return;
    }

    const items = Array.isArray(parsed) ? parsed : [parsed];
    const payload = { password, recipes: items };

    const statusEl = document.getElementById('statusRaw');
    statusEl.textContent = 'Saving…';
    try {
      const r = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.error || 'save-failed');
      statusEl.textContent = `Saved ✔ (${j.count || items.length} recipe${(j.count||items.length)===1?'':'s'})`;
      setTimeout(() => statusEl.textContent = '', 2000);
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Error saving — see console.';
    }
  });
});
</script>
</body>
</html>
