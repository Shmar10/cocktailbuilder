<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cocktail Recipe Generator</title>
  <meta name="description" content="Pick your base spirit(s) + preferences and get a cocktail recipe." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:1rem; padding:.5rem 1rem; font-weight:600; border:1px solid #e5e7eb; background:#fff; }
    .btn-primary { background:#6d28d9; color:#fff; border-color:#6d28d9; }
    .btn-primary:hover { filter:brightness(.95); }
    .card { border:1px solid #e5e7eb; border-radius:1rem; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .input, .select { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; background:#fff; }
    .tag { display:inline-flex; align-items:center; border:1px solid #d1d5db; border-radius:9999px; padding:.125rem .5rem; font-size:.75rem; font-weight:600; margin-right:.25rem; margin-bottom:.25rem; background:#fff; color:#374151; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-violet-50 text-slate-800">
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-extrabold tracking-tight">üç∏ Cocktail Recipe Generator</h1>
      <nav class="flex items-center gap-2 text-sm">
        <a class="btn" href="admin.html">Admin</a>
        <a class="btn" href="#how">How it works</a>
        <section class="card p-4 mt-4">
  <h2 class="text-lg font-bold mb-2">Maintenance</h2>
  <button id="exportCatalogBtn" class="btn">Export merged catalog.js</button>
</section>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6 grid gap-6 lg:grid-cols-5">
    <!-- Search -->
    <section class="card p-4 lg:col-span-5">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-lg font-bold">Search recipes</h2>
        <div class="text-sm text-gray-500" id="searchCount"></div>
      </div>
      <div class="mt-2 grid gap-2 sm:grid-cols-[1fr_auto_auto]">
        <input id="searchBox" class="input" placeholder="type to search (e.g., pineapple, mezcal, coupe)‚Ä¶" />
        <button id="searchClear" class="btn">Clear</button>
        <button id="searchExport" class="btn">Export results</button>
      </div>
     <p class="text-xs text-gray-500 mt-1">Searches name, ingredients, method, tags, and base. Click a result to open it.</p>
      <div id="searchResults" class="mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>
    <!-- Controls -->
    <section class="card p-4 lg:col-span-2">
      <h2 class="text-lg font-bold mb-3">Your criteria</h2>
      <div class="grid gap-4">
        <div>
          <label class="font-semibold">Base spirit (pick 1‚Äì2)</label>
          <div id="baseSpirits" class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3">
            <!-- checkboxes injected by JS -->
          </div>
        </div>
        <div>
          <label class="font-semibold" for="style">Style</label>
          <select id="style" class="select mt-2">
            <option value="any">Any</option>
            <option value="spirit-forward">Spirit-forward</option>
            <option value="citrusy">Citrusy / Sour</option>
            <option value="bubbly">Bubbly</option>
            <option value="tiki">Tropical / Tiki</option>
            <option value="bitter">Bitter / Amaro</option>
            <option value="dessert">Dessert / Creamy</option>
            <option value="herbal">Herbal</option>
          </select>
        </div>
        <div>
          <label class="font-semibold" for="sweetness">Sweetness</label>
          <select id="sweetness" class="select mt-2">
            <option value="any">Any</option>
            <option value="dry">Dry</option>
            <option value="balanced">Balanced</option>
            <option value="sweet">Sweet</option>
          </select>
        </div>
        <div>
          <label class="font-semibold" for="effort">Effort</label>
          <select id="effort" class="select mt-2">
            <option value="any">Any</option>
            <option value="quick">Quick (‚â§ 4 ingredients)</option>
            <option value="standard">Standard (5‚Äì6)</option>
            <option value="fancy">Fancy (7+)</option>
          </select>
        </div>
        <div class="flex flex-wrap gap-2 pt-1">
          <button id="generateBtn" class="btn btn-primary">Generate</button>
          <button id="regenBtn" class="btn" disabled>‚Üª Regenerate</button>
          <button id="resetBtn" class="btn">Reset</button>
        </div>
      </div>
    </section>

    <!-- Output -->
    <section class="lg:col-span-3 grid gap-4">
      <div id="result" class="card p-5 hidden"></div>
      <div id="noResult" class="card p-5 hidden">
        <h3 class="font-bold">No exact matches.</h3>
        <p class="text-sm text-gray-600 mt-1">Try loosening criteria. Here are near matches by base:</p>
        <div id="nearWrap" class="mt-3 grid gap-3"></div>
      </div>

      <section id="how" class="card p-4">
        <h2 class="text-lg font-bold">How it works</h2>
        <ul class="list-disc pl-6 text-sm text-gray-700 mt-2 space-y-1">
          <li>Seed recipes live in <code>catalog.js</code>.</li>
          <li>Admin adds/updates recipes from <code>admin.html</code>. They‚Äôre stored in <code>custom-recipes.json</code>.</li>
          <li>On load, this page merges both and auto-updates the base spirit list (new bases included).</li>
        </ul>
      </section>
    </section>
  </main>

  <footer class="mx-auto max-w-5xl px-4 py-8 text-center text-xs text-gray-500">
    No tracking. Built with vanilla JS.
  </footer>

  <!-- Load the seed catalog -->
  <script src="catalog.js"></script>
  <script>
/** ---------- Helpers & Config ---------- **/
const EXCLUDE_MODIFIERS = new Set([
  'aperol','campari','amaro','coffee liqueur','triple sec','cura√ßao',
  'chartreuse green','chartreuse yellow','vermouth sweet','vermouth dry','champagne','prosecco'
]);

// Treat ANY rum/rhum variant as "rum"; roll "cognac" into "brandy".
function normBase(b) {
  const s = String(b).toLowerCase().trim();
  if (s.includes('rhum agricole')) return 'rum'; // change to 'rhum agricole' if you want it separate
  if (s.includes('rum') || s.includes('rhum')) return 'rum';
  if (s === 'cognac') return 'brandy';
  return s;
}
const titleCase = s => s.replace(/\b\w/g, c => c.toUpperCase());
const slugify = s => s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const randomOf = arr => arr[Math.floor(Math.random()*arr.length)];
const tag = t => `<span class="tag">${t}</span>`;

/** ---------- State ---------- **/
const state = { bases:new Set(), style:'any', sweetness:'any', effort:'any', lastPool:[], lastPick:null };

/** ---------- Boot ---------- **/
document.addEventListener('DOMContentLoaded', () => { boot().catch(console.error); });

async function boot(){
  const seed = Array.isArray(window.RECIPES) ? window.RECIPES : [];
  const custom = await fetchCustom();
  window.ALL_RECIPES = [...seed, ...custom];

  buildBaseCheckboxes(window.ALL_RECIPES);
  hydrateFromUrl();

  document.getElementById('style').addEventListener('change', e => { state.style = e.target.value; syncUrl(); });
  document.getElementById('sweetness').addEventListener('change', e => { state.sweetness = e.target.value; syncUrl(); });
  document.getElementById('effort').addEventListener('change', e => { state.effort = e.target.value; syncUrl(); });

  document.getElementById('generateBtn').addEventListener('click', handleGenerate);
  document.getElementById('regenBtn').addEventListener('click', handleRegenerate);
  document.getElementById('resetBtn').addEventListener('click', resetAll);
}

async function fetchCustom(){
  try {
    const r = await fetch('custom-recipes.json', { cache:'no-store' });
    if (!r.ok) return [];
    const j = await r.json();
    return Array.isArray(j) ? j : [];
  } catch { return []; }
}

/** ---------- UI ---------- **/
function buildBaseCheckboxes(recipes){
  const wrap = document.getElementById('baseSpirits');
  wrap.innerHTML = '';
  const bases = new Set();
  recipes.forEach(r => (r.base||[]).forEach(b => {
    const nb = normBase(String(b).toLowerCase());
    if (!EXCLUDE_MODIFIERS.has(nb)) bases.add(nb);
  }));
  Array.from(bases).sort().forEach(id => {
    const idAttr = `base-${id.replace(/\s+/g,'-')}`;
    const div = document.createElement('div');
    div.innerHTML = `
      <label class="flex items-center gap-2 border rounded-xl px-3 py-2 hover:bg-gray-50 cursor-pointer">
        <input type="checkbox" id="${idAttr}" value="${id}" class="accent-violet-600">
        <span>${titleCase(id)}</span>
      </label>`;
    wrap.appendChild(div);
    div.querySelector('input').addEventListener('change', (e) => {
      if (e.target.checked) {
        if (state.bases.size >= 2) {
          const [first] = state.bases;
          document.getElementById(`base-${first.replace(/\s+/g,'-')}`).checked = false;
          state.bases.delete(first);
        }
        state.bases.add(e.target.value);
      } else {
        state.bases.delete(e.target.value);
      }
      syncUrl();
    });
  });
}

/** ---------- URL sync ---------- **/
function hydrateFromUrl(){
  const p = new URLSearchParams(location.search);
  (p.get('bases')||'').split(',').filter(Boolean).slice(0,2).forEach(b => {
    const cb = document.getElementById(`base-${b.replace(/\s+/g,'-')}`);
    if (cb){ cb.checked = true; state.bases.add(b); }
  });
  ['style','sweetness','effort'].forEach(k => { if (p.get(k)){ state[k] = p.get(k); document.getElementById(k).value = state[k]; } });
}
function syncUrl(){
  const p = new URLSearchParams();
  if (state.bases.size) p.set('bases', Array.from(state.bases).join(','));
  ['style','sweetness','effort'].forEach(k => { if (state[k] !== 'any') p.set(k, state[k]); });
  history.replaceState(null, '', location.pathname + (p.toString()?`?${p.toString()}`:''));
}

/** ---------- Filtering & Render ---------- **/
function matchesCriteria(r){
  const chosen = Array.from(state.bases);
  if (chosen.length){
    const rbases = (r.base||[]).map(x => normBase(String(x).toLowerCase()));
    if (!chosen.map(normBase).every(b => rbases.includes(b))) return false;
  }
  if (state.style !== 'any' && !(r.profile||[]).includes(state.style)) return false;
  if (state.sweetness !== 'any' && r.sweetness !== state.sweetness) return false;
  const n = (r.ingredients||[]).length;
  const bucket = n<=4?'quick':(n>=7?'fancy':'standard');
  if (state.effort !== 'any' && state.effort !== bucket) return false;
  return true;
}

function handleGenerate(){
  state.lastPool = window.ALL_RECIPES.filter(matchesCriteria);
  pickAndRender(state.lastPool);
}
function handleRegenerate(){
  if (!state.lastPool.length){ handleGenerate(); return; }
  pickAndRender(state.lastPool.filter(r => !state.lastPick || r.id !== state.lastPick.id));
}

function pickAndRender(pool){
  const resultEl = document.getElementById('result');
  const noResult = document.getElementById('noResult');
  const nearWrap = document.getElementById('nearWrap');

  if (!pool.length){
    // near matches by base only
    const chosen = Array.from(state.bases);
    const near = window.ALL_RECIPES.filter(r => {
      if (!chosen.length) return false;
      const rbases = (r.base||[]).map(x => normBase(String(x).toLowerCase()));
      return chosen.map(normBase).every(b => rbases.includes(b));
    }).slice(0,4);
    nearWrap.innerHTML = near.map(r => `<div class="card p-3">
      <div class="flex items-center justify-between">
        <h4 class="font-semibold">${r.name}</h4>
        <button data-open="${r.id}" class="text-violet-600 underline">Open</button>
      </div>
      <div class="mt-1 text-xs text-gray-600">${(r.profile||[]).map(tag).join('')}</div>
    </div>`).join('') || '<p class="text-sm text-gray-500">No near matches either‚Äîclear a filter.</p>';
    resultEl.classList.add('hidden'); noResult.classList.remove('hidden');
    document.getElementById('regenBtn').disabled = true;
    wrapOpenHandlers();
    return;
  }

  const pick = randomOf(pool); state.lastPick = pick;
  resultEl.innerHTML = recipeCard(pick);
  resultEl.classList.remove('hidden'); noResult.classList.add('hidden');
  document.getElementById('regenBtn').disabled = pool.length <= 1;
  wrapOpenHandlers();
}

function wrapOpenHandlers(){
  document.querySelectorAll('[data-open]').forEach(btn => btn.addEventListener('click', e => {
    const id = e.currentTarget.getAttribute('data-open');
    const r = window.ALL_RECIPES.find(x => x.id === id);
    if (r){ document.getElementById('result').innerHTML = recipeCard(r); document.getElementById('result').classList.remove('hidden'); document.getElementById('noResult').classList.add('hidden'); }
  }));
}

function recipeCard(r){
  const ing = (r.ingredients||[]).map(([a,i]) => `<li><b>${a}</b> ${i}</li>`).join('');
  const base = (r.base||[]).map(b => titleCase(normBase(String(b).toLowerCase()))).filter((v,i,a)=>a.indexOf(v)===i).join(' + ');
  const n = (r.ingredients||[]).length;
  const effort = n<=4?'quick':(n>=7?'fancy':'standard');
  return `
    <article>
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl font-extrabold">${r.name}</h2>
          <p class="text-sm text-gray-600">${base} ‚Ä¢ ${titleCase((r.profile||[])[0]||'')} ‚Ä¢ ${titleCase(r.sweetness||'balanced')} ‚Ä¢ ${titleCase(effort)}</p>
        </div>
        <button class="btn" id="copyBtn">Copy</button>
      </div>
      <div class="grid sm:grid-cols-3 gap-4 mt-4">
        <div class="sm:col-span-2 card p-4">
          <h3 class="font-bold mb-2">Ingredients</h3>
          <ul class="list-disc pl-6">${ing}</ul>
        </div>
        <div class="card p-4">
          <h3 class="font-bold mb-2">Details</h3>
          <p><b>Method:</b> ${r.method||''}</p>
          <p><b>Glass:</b> ${r.glass||''}</p>
          ${r.garnish?`<p><b>Garnish:</b> ${r.garnish}</p>`:''}
          <div class="mt-2">${(r.tags||[]).map(tag).join('')}</div>
        </div>
      </div>
    </article>
  `;
}

/** ---------- Reset ---------- **/
function resetAll(){
  document.querySelectorAll('#baseSpirits input[type=checkbox]').forEach(cb => cb.checked = false);
  state.bases.clear(); state.style='any'; state.sweetness='any'; state.effort='any';
  document.getElementById('style').value='any'; document.getElementById('sweetness').value='any'; document.getElementById('effort').value='any';
  document.getElementById('result').classList.add('hidden'); document.getElementById('noResult').classList.add('hidden');
  document.getElementById('regenBtn').disabled = true;
  syncUrl();
}

document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'copyBtn') {
    const el = document.createElement('textarea');
    el.value = document.getElementById('result').innerText;
    document.body.appendChild(el); el.select(); document.execCommand('copy'); el.remove();
  }
});
  /** ---------- Search (name, base, ingredients, tags, method) ---------- **/
const searchBox = document.getElementById('searchBox');
const searchResults = document.getElementById('searchResults');
const searchCount = document.getElementById('searchCount');
const searchClear = document.getElementById('searchClear');
const searchExport = document.getElementById('searchExport');

function searchHits(r, q) {
  const s = q.toLowerCase();
  const hit = (txt) => String(txt||'').toLowerCase().includes(s);
  if (hit(r.name)) return true;
  if (hit(r.method)) return true;
  if ((r.base||[]).some(hit)) return true;
  if ((r.tags||[]).some(hit)) return true;
  if ((r.ingredients||[]).some(([a,i]) => hit(a) || hit(i))) return true;
  return false;
}

function renderSearchResults(list) {
  searchResults.innerHTML = '';
  searchCount.textContent = `${list.length} match${list.length===1?'':'es'}`;
  if (!list.length) {
    searchResults.innerHTML = '<p class="text-sm text-gray-500">No matches. Try another term.</p>';
    return;
  }
  list.slice(0, 60).forEach(r => {
    const ing = (r.ingredients||[]).map(([a,i]) => `<li><b>${a}</b> ${i}</li>`).join('');
    const card = document.createElement('div');
    card.className = 'card p-3';
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <h4 class="font-semibold">${r.name}</h4>
        <button class="text-violet-600 underline" data-open="${r.id}">Open</button>
      </div>
      <div class="text-xs text-gray-600 mt-1">${(r.base||[]).map(b=>titleCase(normBase(String(b).toLowerCase()))).filter((v,i,a)=>a.indexOf(v)===i).join(', ')}</div>
      ${(r.tags||[]).length ? `<div class="mt-1">${(r.tags||[]).map(tag).join('')}</div>`:''}
      <details class="mt-2">
        <summary class="cursor-pointer text-sm">Preview ingredients</summary>
        <ul class="list-disc pl-6 text-sm mt-1">${ing}</ul>
      </details>
    `;
    searchResults.appendChild(card);
  });
  wrapOpenHandlers();
}

function doSearch(q) {
  const term = (q||'').trim();
  const params = new URLSearchParams(location.search);
  if (term) params.set('q', term); else params.delete('q');
  history.replaceState(null, '', location.pathname + (params.toString()?`?${params}`:''));

  if (!term) { searchResults.innerHTML=''; searchCount.textContent=''; return; }
  const pool = (window.ALL_RECIPES||[]).filter(r => searchHits(r, term));
  renderSearchResults(pool);
}

function hydrateSearchFromUrl() {
  const p = new URLSearchParams(location.search);
  const q = p.get('q') || '';
  if (q) { searchBox.value = q; doSearch(q); }
}

// Wire events after boot() merges seed + custom
document.addEventListener('DOMContentLoaded', () => {
  // When your boot() finishes, it sets window.ALL_RECIPES; run this a tick later.
  setTimeout(hydrateSearchFromUrl, 0);

  searchBox?.addEventListener('input', (e) => doSearch(e.target.value));
  searchClear?.addEventListener('click', () => { searchBox.value=''; doSearch(''); });
  searchExport?.addEventListener('click', () => {
    const term = searchBox.value.trim();
    const list = term ? (window.ALL_RECIPES||[]).filter(r=>searchHits(r, term)) : [];
    const blob = new Blob([JSON.stringify(list, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = term ? `recipes-search-${term}.json` : 'recipes.json';
    document.body.appendChild(a); a.click(); a.remove();
  });
});
  </script>
</body>
</html>
